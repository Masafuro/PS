# 共有変数ドメイン仕様詳細

本フレームワークは、データの整合性とシステムの堅牢性を維持するため、**4つのドメイン（領域）**と**3つのアクセス窓口（インスタンス）**を使い分ける「ドメイン統治体制」を採用しています。

## 権限マトリクス

どの変数インスタンスをインポートするかによって、各ドメインに対する操作権限がシステムレベルで制限されます。

| 変数名（インポート元） | loop領域 | keep領域 | master領域 | system領域 | 動作モデル |
| --- | --- | --- | --- | --- | --- |
| **`loop_var`** (`1_loop`) | **RW** | **R** | **R** | **R** | **スナップショット・コミット** |
| **`keep_var`** (`3_keep`) | **R** | **RW** | **R** | **R** | **ダイレクトアクセス（保護付）** |
| **`master_var`** (Setup等) | **RW** | **RW** | **RW** | **R** | **フルアクセス（管理者）** |

> **RW**: 読み書き可能 / **R**: 読み取り専用（書き込みは無視またはマスターに反映されません）

---

## 各ドメインの詳細規定

### 1. loopドメイン（制御ロジック領域）

* **所有権**: `1_loop` フェーズ
* **挙動**: サイクル開始時に取得した「スナップショット」を操作し、サイクル終了時にその結果をマスターへ一括で書き戻します（コミット）。
* **目的**: 演算中に他フェーズの影響を受けず、1サイクル内でのロジックの一貫性を保証します。

### 2. keepドメイン（非同期I/O領域）

* **所有権**: `3_keep` フェーズ
* **挙動**: メインループの周期に関わらず、常に最新であるべき情報（通信、センサー等）を格納します。書き込まれた内容は即座に反映されます。
* **目的**: 通信ステータスや外部機器とのリアルタイムな同期を可能にします。

### 3. masterドメイン（運転パラメータ領域）

* **所有権**: `0_setup` フェーズ（管理者）
* **挙動**: 通常は起動時に一度だけ設定されます。運用開始後は `1_loop` や `3_keep` からは読み取り専用となり、予期せぬ改ざんを防ぎます。
* **目的**: 運転条件、タイムアウト値、URLなどの設定値を一元管理します。

### 4. systemドメイン（システム不変領域：憲法）

* **所有権**: **なし（完全不変）**
* **挙動**: YAMLで定義された初期値が、実行中のあらゆる操作から保護されます。管理者権限を持つ `master_var` であっても書き換えられません。
* **目的**: ソフトウェアバージョンやハードウェア定義など、絶対に変化してはならない情報を「憲法」として保護します。

---

## 保護メカニズムの仕組み

本フレームワークは、Pythonの**プロパティ機能**と**ディープコピー（深い複製）**を利用して、物理的なメモリ書き換えを防御しています。

> **コピー保護の仕組み**
> 読み取り専用として定義されている領域（例：`keep_var` から見た `loop` 領域や、全員から見た `system` 領域）にアクセスすると、システムは自動的にデータの「複製」を生成して渡します。利用者がそのコピーを書き換えても、マスターデータの実体には1bitも影響を与えません。

---

## 次のステップ

具体的な実装方法や、書き換えがどのようにブロックされるかのコード例については、以下のドキュメントを参照してください。

* [実装サンプル集 (README_SAMPLECODE.md)](./README_SAMPLECODE.md)

