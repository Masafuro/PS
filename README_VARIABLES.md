# 共有変数ドメイン仕様書

本フレームワークは、データの整合性を守るために「所有権の保護」と「アクセス権限の自動切り替え」を採用しています。

## 4つのドメイン構成
変数は `variables.yaml` で定義され、その役割に応じて以下の4つのドメインに分類されます。

| ドメイン | 性質 | 主な用途 | 権限の概要 |
| :--- | :--- | :--- | :--- |
| **loop** | 同期領域 | 制御ロジック、計算 | 1_loopのみ書き込み可。 |
| **keep** | 非同期領域 | 通信ステータス、I/O | 3_keepのみ書き込み可。 |
| **master** | 設定領域 | 運転パラメータ、定数 | 0_setupのみ書き込み可。 |
| **system** | 不変領域 | システム憲法、製品情報 | **いかなる権限からも書き換え不可。** |



## アクセス権限マトリクス
使用する変数インスタンスによって、物理的なアクセス制限が自動的に適用されます。

* **loop_var**: 1_loopで使用。スナップショット方式を採用し、サイクル中の値の一貫性を保証します。終了時にloopドメインのみマスターへ反映されます。
* **keep_var**: 3_keepで使用。keepドメインへの即時反映を可能にしつつ、他ドメインへの書き換え試行を自動的にブロック（コピーへの書き込みに置換）します。
* **master_var**: 0_setup, 2_teardownで使用。全領域（systemを除く）への直接書き込み権限を持ちます。

## 隔離メカニズム：systemドメイン
systemドメインは「システムの憲法」として設計されており、`master_var` を用いてもメモリ上の実体を書き換えることはできません。これは、アクセス時に常にディープコピーを返すことで実現されており、フレームワークレベルでの不変性が担保されています。