# Python Sequencer 開発指針

## 1. プロジェクトの目的
本プロジェクトは、産業用PLC（シーケンサ）の設計思想に基づき、Pythonスクリプトを高速かつ動的に実行・管理するためのシステムを構築することを目的とする。

## 2. ディレクトリ構造と役割
プロジェクトのルートディレクトリ配下に以下のフォルダを配置し、各スクリプトの役割を明確に分離する。

| フォルダ名 | 分類 | 実行タイミング | 主な役割 |
| :--- | :--- | :--- | :--- |
| **0_setup** | 初期化 | 起動時に1回のみ | 環境変数、DB接続、共有メモリの初期設定 |
| **3_keep** | 常駐 | setup完了後〜終了前 | サーバー、監視プロセス等の並列実行タスク |
| **1_loop** | 循環 | 稼働中（継続実行） | メインロジック、計算処理、定期実行タスク |
| **2_teardown** | 終了 | keep停止後、終了時 | リソース解放、ログ保存、安全停止処理 |
| **common** | 共有 | 実行対象外 | 各スクリプトから参照される共通ライブラリや定数 |

## 3. 実行インターフェースの規則
管理の簡素化と動的実行を確実にするため、実行対象となるすべてのスクリプトに以下の共通ルールを適用する。

* すべてのスクリプトは、実行の入り口として `execute()` 関数を定義しなければならない。
* ファイル名の先頭には実行順序を制御するための番号（例：p001_xxx.py）を付与する。

## 4. 実行エンジン（シーケンサー）の設計
サイクル実行の負荷を最小限に抑えるため、以下の技術的アプローチを採用する。

* **インメモリリスト方式**: スクリプトは `subprocess` ではなく `importlib` を介してメモリ上にロードし、関数オブジェクトとして保持する。
* **逐次実行の徹底**: 0_setup, 1_loop, 2_teardown はファイル名順に一つずつ実行され、前の処理の完了を待ってから次へ進む。
* **並列実行の管理**: 3_keep 内のタスクは別プロセスまたは別スレッドとして起動し、メインループをブロックしないように制御する。

## 5. ライフサイクル管理（実行フロー）
プログラム起動から終了までの遷移順序は以下の通りとする。

1. **初期化フェーズ**: 0_setup 内のスクリプトを順次実行。
2. **常駐開始フェーズ**: 3_keep 内のスクリプトを並列起動。
3. **メインフェーズ**: 1_loop 内のスクリプトを循環実行（スキャンサイクル）。
4. **停止信号検知**: 1_loop のサイクルを停止。
5. **常駐停止フェーズ**: 3_keep で起動した各プロセスを安全に終了させる。
6. **終了フェーズ**: 2_teardown 内のスクリプトを順次実行し、システムを終了。